/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Component","sap/ui/fl/Utils","sap/ui/core/routing/History","sap/ui/core/routing/HashChanger","sap/base/Log","sap/base/util/equal"],function(q,C,f,H,a,L,e){"use strict";var v="sap-ui-fl-control-variant-id";var V={initializeHashRegister:function(){this._oHashRegister={currentIndex:null,hashParams:[]};V._setOrUnsetCustomNavigationForParameter.call(this,true);},attachHashHandlers:function(){if(this._oHashRegister.currentIndex===null){var h=a.getInstance();h.attachEvent("hashReplaced",V._handleHashReplaced,this);h.attachEvent("hashChanged",V._navigationHandler,this);var o=this.oComponent.destroy;this.oComponent.destroy=function(){V._setOrUnsetCustomNavigationForParameter.call(this,false);h.detachEvent("hashReplaced",V._handleHashReplaced,this);h.detachEvent("hashChanged",V._navigationHandler,this);this.destroy();o.apply(this.oComponent,arguments);}.bind(this);V._navigationHandler.call(this);}},updateHasherEntry:function(p){if(!p||!Array.isArray(p.parameters)){L.info("Variant URL parameters could not be updated since invalid parameters were received");return;}if(p.updateURL){f.setTechnicalURLParameterValues(p.component||this.oComponent,v,p.parameters);}if(!p.ignoreRegisterUpdate){this._oHashRegister.hashParams[this._oHashRegister.currentIndex]=p.parameters;}},_handleHashReplaced:function(E){this._sReplacedHash=E.getParameter("sHash");},_navigationHandler:function(E){var d;var n=E&&E.getParameter("newHash");if(n&&this._sReplacedHash===n){delete this._sReplacedHash;return;}if(this._oHashRegister.currentIndex===null){this._oHashRegister.currentIndex=0;d="NewEntry";}else{d=H.getInstance().getDirection();switch(d){case"Backwards":this._oHashRegister.currentIndex--;break;case"Forwards":case"NewEntry":this._oHashRegister.currentIndex++;break;case"Unknown":this._oHashRegister.currentIndex=0;this._oHashRegister.hashParams=[];this.switchToDefaultVariant();break;default:return;}}if(this._oHashRegister.currentIndex>=0){var b;var p={};if(d==="NewEntry"||d==="Unknown"){var h=f.getParsedURLHash()&&f.getParsedURLHash().params;b=(h&&h[v])||[];var c=this._oHashRegister.hashParams[this._oHashRegister.currentIndex];if(Array.isArray(c)){c.forEach(function(P){this.switchToDefaultVariant(P);}.bind(this));}p={parameters:b};}else{b=this._oHashRegister.hashParams[this._oHashRegister.currentIndex];p={parameters:b,updateURL:true,ignoreRegisterUpdate:true};}}else{p={parameters:[],updateURL:true,ignoreRegisterUpdate:true};}this.updateHasherEntry(p);},_setOrUnsetCustomNavigationForParameter:function(s){var m=s?"registerNavigationFilter":"unregisterNavigationFilter";var u=f.getUshellContainer();if(u){u.getService("ShellNavigation")[m](V._navigationFilter);}},_navigationFilter:function(n,o){var u=f.getUshellContainer();var U=u.getService("URLParsing");var s=u.getService("ShellNavigation");var O=U.parseShellHash(o);var N=U.parseShellHash(n);var S=O&&N&&!e(O.params[v],N.params[v]);if(S){for(var k in O){if(k!=="params"&&k!=="appSpecificRoute"&&O[k]!==N[k]){S=false;break;}}}if(S){S=false;[O,N].forEach(function(p){if(p.params.hasOwnProperty(v)){S=true;if(Object.keys(p.params).length!==1){S=false;}}else if(Object.keys(p.params).length!==0){S=false;}});}if(S){var A=(N.appSpecificRoute||"  ").substring(2);var b=(O.appSpecificRoute||"  ").substring(2);s.hashChanger.fireEvent("hashChanged",{newHash:A,oldHash:b});return{status:s.NavigationFilterStatus.Custom};}return s.NavigationFilterStatus.Continue;},getCurrentHashParamsFromRegister:function(){if(q.isNumeric(this._oHashRegister.currentIndex)){return this._oHashRegister.hashParams[this._oHashRegister.currentIndex];}}};return V;},true);
